networks:
  default:
    name: maeve-csms
    enable_ipv6: true
    ipam:
      config:
        - subnet: 2001:db8:a::/64
          gateway: 2001:db8:a::1

services:
  mqtt:
    image: eclipse-mosquitto:2
    volumes:
      - type: bind
        source: ./config/mosquitto
        target: /mosquitto/config
        read_only: true
    ports:
      - "1883:1883"
      - "9000:9000"
    user: "10000:10000"
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 mosquitto_sub -t '$$SYS/#' -C 1 | grep -v Error || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 3

  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: maeve_csms
      POSTGRES_USER: maeve
      POSTGRES_PASSWORD: maeve_dev_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U maeve -d maeve_csms"]
      interval: 5s
      timeout: 5s
      retries: 5

  postgres-migrate:
    build:
      context: manager
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: "postgres://maeve:maeve_dev_password@postgres:5432/maeve_csms?sslmode=disable"
    command:
      - "/bin/sh"
      - "-c"
      - |
        echo "Running database migrations..."
        if [ -f /app/manager ]; then
          /app/manager migrate -c /config/config-postgres.toml
        else
          echo "Warning: manager binary not found, skipping migrations"
        fi
    volumes:
      - type: bind
        source: ./config/manager
        target: /config
        read_only: true
    restart: "no"

  gateway:
    build:
      context: gateway
    depends_on:
      mqtt:
        condition: service_healthy
      manager:
        condition: service_healthy
    command:
      - "serve"
      - "--ws-addr"
      - ":9310"
      - "--wss-addr"
      - ":9311"
      - "--status-addr"
      - ":9312"
      - "--tls-server-cert"
      - "/certificates/csms.pem"
      - "--tls-server-key"
      - "/certificates/csms.key"
      - "--tls-trust-cert"
      - "/certificates/trust.pem"
      - "--mqtt-addr"
      - "mqtt://mqtt:1883"
      - "--manager-api-addr"
      - "http://manager:9410"
    ports:
      - "80:9310" # charge station ws
      - "443:9311" # charge station wss
      - "9312:9312" # status
    volumes:
      - type: bind
        source: ./config/certificates
        target: /certificates
        read_only: true
    healthcheck:
      test: ["CMD", "/usr/bin/curl", "-s", "--fail", "http://localhost:9312/health"]
      interval: 10s
      timeout: 10s
      retries: 3
    user: "${UID}:${GID}"

  manager:
    build:
      context: manager
    depends_on:
      mqtt:
        condition: service_healthy
      postgres:
        condition: service_healthy
      postgres-migrate:
        condition: service_completed_successfully
    environment:
      ENVIRONMENT: dev
      DATABASE_URL: "postgres://maeve:maeve_dev_password@postgres:5432/maeve_csms?sslmode=disable"
    command:
      - "serve"
      - "-c"
      - "/config/config-postgres.toml"
    volumes:
      - type: bind
        source: ./config/certificates
        target: /certificates
        read_only: true
      - type: bind
        source: ./config/manager
        target: /config
        read_only: true
    ports:
      - "9410:9410" # manager api
      - "9411:9411" # status
    healthcheck:
      test: ["CMD", "/usr/bin/curl", "-s", "--fail", "http://localhost:9410/health"]
      interval: 10s
      timeout: 10s
      retries: 3
    user: "${UID}:${GID}"

volumes:
  postgres_data:
